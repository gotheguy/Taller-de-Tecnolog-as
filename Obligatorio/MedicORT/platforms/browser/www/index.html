<!doctype html>
<html>
<head>
    <title>MedicORT</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" type="text/css">
    <link rel="stylesheet" href="img/images/jQuery-Mobile-Icon-Pack-master/dist/jqm-icon-pack-fa.css"/>
    <link href="https://cdn.jsdelivr.net/npm/jtsage-datebox-jqm@4.4.1/jtsage-datebox.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jtsage-datebox-jqm@4.4.1/jtsage-datebox.min.js"></script>
    <script>
        $(document).ready(function(){
            $("div").html(function (i, html) {
                return html.replace(/&nbsp;/g, '');
            });
        });

        function getSession() {
            return sessionStorage.getItem("session");
        }

        function setSession(mailUser) {
            sessionStorage.clear();
            sessionStorage.setItem("session", mailUser);
        }

        function getDoctor(id) {
            if(sessionStorage.getItem(id) != null) {
                return sessionStorage.getItem(id);
            }
        }

         function setDoctor(id,nombreDoc,apellidoDoc) {
            if(sessionStorage.getItem(id) == null) {
                sessionStorage.setItem(id,nombreDoc + ' ' + apellidoDoc);
            }
        }       

        function loadingShow() {
            var interval = setInterval(function(){
                $.mobile.loading('show');
                clearInterval(interval);
            },1); 
        }

        function loadingHide() {
            var interval = setInterval(function(){
                $.mobile.loading('hide');
                clearInterval(interval);
            },1); 
        }

        function login(){
			loadingShow();
			$.ajax({
				data: {email: $('#usuarioLog').val(), password: $('#passwordLog').val()},
				type: "GET",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/login",
				success: function(data){
					loadingHide();
                    if(data.resultado_login) {
                       setSession(data.email);
                       window.location.replace("#main-menu");
                    }
				},
                error: function(data){
                    loadingHide();
                    if(!data.resultado_login) {
                        $('#PopupLogin').popup();
                        $("#PopupLogin").popup("open");
                    }
                }
			});
        }
        
        function registrar() {
			loadingShow();
			$.ajax({
                data: {email: $('#emailReg').val(), password: $('#passwordReg').val(), nombre: $('#nombreReg').val(), apellido: $('#apellidoReg').val(),
                       documento: $('#documentoReg').val(), telefono: $('#telefonoReg').val()},
				type: "POST",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/registrar",
				success: function(data){
					loadingHide();
                    if(data.retorno = "OK") {
                        setSession(data.email);
                        window.location.replace("#main-menu");
                    }
				},
                error: function(data,jqXHR) {
                    loadingHide();
                    if(jqXHR.status = 500) {
                        if(data.retorno = "ERROR") {
                            $('#PopupRegister').popup();
                            $("#PopupRegister").popup("open"); 
                        }
                    }
                }
			});
		}

		function getProfesionales(){
            loadingShow();
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/getProfesionales",
				success: function(data){
                    loadingHide();
                    if(data.retorno = "OK") {
                    var items = []; 
                    $.each(data.profesionales, function(i,item) {
                        var aux = data.profesionales[i];
                            $('#listviewDoc').empty();
                            //setDoctor(aux.id,aux.nombre,aux.apellido);
                            items.push('<li id="' + aux.id + '" class="info-doc-li"><a href="#info-doc-detalle" data-transition="slide" class="doclist-item">' +
                            '<img src="' + aux.foto + '" alt="Imagen doctor"><h3 id="' + aux.id + '" class="doclist-name">' +
                            aux.nombre + ' ' + aux.apellido + '</h3><p class="doclist-specialty">' + aux.especialidad + '</p></a></li>');
                        });
                        $('#listviewDoc').append(items.join(''));
                        $('#listviewDoc').listview().listview('refresh');

                        $('#listviewDoc li').click(function(){
                            //getDetalleProfesional(this.id);
                            alert(this.id + ' ' + $('.doclist-name').text());
                        });
                    }
                }
            });
        }

		function getDetalleProfesional(idDoc){
            loadingShow();
            var doctor = splitDoctor(idDoc);
			$.ajax({
                data: {nombre: doctor[0], apellido: doctor[1]},
				type: "GET",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/getDetalleProfesional",
				success: function(data){
                    if(data.retorno = "OK") {
                        loadingHide();
                            $("#reservar-consulta").click(function() {
                                //fijarConsultaMedica(data.profesional.id,getSession(),data.profesional.nombre,data.profesional.apellido,data.profesional.centroMedico.nombre);
                                alert(splitDoctor(1));
                        });

                        var items = []; 
                        $(".card").html("");
                        items.push('<img src="' + data.profesional.foto + '" alt="Imagen doctor en detalle" class="card-img"><div class="container">' + 
                        '<h3 class="card-name">' + data.profesional.nombre + ' ' + data.profesional.apellido + 
                        '</h3><h5 class="card-title">' + data.profesional.titulo + '</h5><h5 class="card-prof">' + 
                        data.profesional.especialidad + '</h5><h3 class="card-punt">' + (Math.round(data.profesional.puntuacion * 100) / 100)  + 
                        '</h3><a class="ui-btn ui-btn-b ui-corner-all card-clin">' + data.profesional.centroMedico.nombre + '</a></div>');
                        $('.card').append(items.join(''));


                        $("#calificar-consulta").click(function() {
                            $('#PopupPuntaje').popup();
                            $('#PopupPuntaje').popup('open');

                            $("#ui-ok-button-puntaje").click(function() {
                                asignarPuntajeAProfesional(data.profesional.nombre,data.profesional.apellido);
                            });  
                        });
                    }
                },
                error: function(data,jqXHR) {
                    loadingHide();
                    if(jqXHR.status = 500) {
                        if(data.retorno = "ERROR") {
                        }
                    }
                }
            });
        }

        function splitDoctor(id) {
            var doctor = getDoctor(id);
            var split = doctor.split(" ");
            return split;
        }

        function fijarConsultaMedica(idDoc,emailUser,nombreDoc,apellidoDoc,nombreMed) {
			loadingShow();
            var fecha = $('#fechaRes').val() + ' ' + $('#horaRes').val();
			$.ajax({
                data: {email: emailUser, fechaHora: fecha, nombreProfesional: nombreDoc, apellidoProfesional: apellidoDoc, nombreCentroMedico: nombreMed},
				type: "POST",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/fijarConsultaMedica",
				success: function(data){
                    loadingHide();
                    if(data.retorno = "OK") {
                            //alert("Gracias " + nombreDoc + ' ' + apellidoDoc);
                    }
				},
                error: function(data,jqXHR) {
                    loadingHide();
                    if(jqXHR.status = 500) {
                        if(data.retorno = "ERROR") {
                            alert("ERROR " + idDoc + emailUser + fecha + nombreDoc + apellidoDoc + nombreMed);
                        }
                    }
                }
			});
        }   

        function asignarPuntajeAProfesional(nombreDoc,apellidoDoc) {
			loadingShow();
			$.ajax({
                data: {nombre: nombreDoc, apellido: apellidoDoc, puntaje: $('#doctorCal').val()},
				type: "POST",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/asignarPuntajeAProfesional",
				success: function(data){
                    loadingHide();
                    if(data.retorno = "OK") {
                        $('.card-punt').text((Math.round(data.nuevoPuntaje * 100) / 100));
                    }
				},
                error: function(data,jqXHR) {
                    loadingHide();
                    if(jqXHR.status = 500) {
                        if(data.retorno = "ERROR") {
                        }
                    }
                }
			});
        }

		function getCentrosMedicos(){
            loadingShow();
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "http://medicort.tribus.com.uy/getCentrosMedicos",
				success: function(data){
                    loadingHide();
                    if(data.retorno = "OK") {
                    var items = []; 
                    $.each(data.centrosMedicos, function(i,item) {
                        var aux = data.centrosMedicos[i];
                            $('#listviewMed').empty();
                            items.push('<li class="info-med-li"><a href="#info-med-detalle" data-transition="slide" class="medlist-item">' +
                            '<h3 class="medlist-name">' + aux.nombre +
                            '</h3><p class="ui-li-aside"><p class="medlist-adress">' + aux.direccion + 
                            '</p></a></li>');
                        });
                        $('#listviewMed').append(items.join(''));
                        $('#listviewMed').listview().listview('refresh');
                    }
                }
            });
        }
    </script>
</head>
<body>
    <div data-role="page" id="start-menu">
        <div data-role="header">
            <img class="appLogo" src="img/images/heartbeat.png" alt="logo"> 
        </div>
        
        <div role="main" class = "ui-content">
            <h2>Bienvenido!</h2>
            <p>Ya estoy registrado</p>
            <a href="#login" data-transition="slide" class="ui-btn ui-btn-b ui-corner-all">Ingresar</a>
            <p>Aún no tienes una cuenta?</p>
            <a href="#register" data-transition="slide" class="ui-btn ui-btn-b ui-corner-all">Registrarme</a>
            <p></p>
        </div>
        
        <div data-role="footer" data-position="fixed">
            <h4></h4>
        </div>
    </div>

    <div data-role="page" id="login">
        <div data-role="header">
        <a href="#start-menu" data-rel="back" data-transition="slide" data-direction="reverse" data-icon="arrow-left"
        class="ui-link ui-btn ui-icon-arrow-left ui-btn-icon-left ui-shadow ui-corner-all"></a>
        <img class="appLogo" src="img/images/heartbeat.png" alt="logo"> 
        </div>
        
        <div role="main" class="ui-content">
        <form id="formLogin" autocomplete="off">
                <fieldset data-role="fieldcontain">
                <label class="registerInput" for="usuarioLog">Email</label>
                <input type="text" name="usuario" id="usuarioLog">
                </fieldset>
                <fieldset data-role="fieldcontain">
                <label class="registerInput" for="passwordLog">Contraseña</label>
                <input type="password" name="password" id="passwordLog">
                </fieldset>
            <div class="button">
                <a href="" class="ui-btn ui-btn-b ui-corner-all" onclick="login()">Ingresar</a>
            </div>
        </form>
        <div data-role="popup" id="PopupLogin" class="Popup" data-overlay-theme="a" data-theme="a" data-dismissible="true" data-transition="slideup">
            <div data-role="header" data-theme="a">
                <h1>¡Upsss!</h1>
            </div>
            <div role="main" class="ui-content popup-text">
                <h3 class="ui-title">Tu email y/o contraseña son incorrectos</h3>
                    <p class="ui-subtitle">¡Vuelve a intentarlo!</p>
                <a href="#" class="ui-btn ui-btn-b ui-corner-all ui-ok-button" data-rel="back" data-transition="slideup">OK</a>
            </div>
        </div>
        </div>
        <div data-role="footer" data-position="fixed">
            <h4></h4>
        </div>
        </div>

    <div data-role="page" id="register">
        <div data-role="header">
            <a href="#start-menu" data-rel="back" data-transition="slide" data-direction="reverse" data-icon="arrow-left"
            class="ui-link ui-btn ui-icon-arrow-left ui-btn-icon-left ui-shadow ui-corner-all"></a>
            <img class="appLogo" src="img/images/heartbeat.png" alt="logo"> 
        </div>
        
        <div role="main" class="ui-content">
            <form id="formRegister" autocomplete="off">
                <fieldset data-role="fieldcontain">
                    <label class="registerInput" for="nombreReg">Nombre</label>
                    <input type="text" name="nombre" id="nombreReg">
                </fieldset>
                <fieldset data-role="fieldcontain">
                    <label class="registerInput" for="apellidoReg">Apellido</label>
                    <input type="text" name="apellido" id="apellidoReg">
                </fieldset>
                <fieldset data-role="fieldcontain">
                    <label class="registerInput" for="passwordReg">Contraseña</label>
                    <input type="password" name="password" id="passwordReg">
                </fieldset>
                <fieldset data-role="fieldcontain">
                    <label class="registerInput" for="emailReg">Email</label>
                    <input type="email" name="email" id="emailReg">
                </fieldset>
                <fieldset class="ui-grid-a sideByside">
                    <div class="ui-block-a">
                        <label class="registerInput" for="documentoReg">Documento</label>
                        <input type="text" name="documento" id="documentoReg">
                    </div>
                    <div class="ui-block-b">
                        <label class="registerInput" for="telefonoReg">Teléfono</label>
                        <input type="text" name="telefono" id="telefonoReg">
                    </div>
                </fieldset>
                <div class="button">
                    <a href="#" class="ui-btn ui-btn-b ui-corner-all" onclick="registrar()">Crear cuenta</a>
                </div>
            </form>
        <div data-role="popup" id="PopupRegister" class="Popup" data-overlay-theme="a" data-theme="a" data-dismissible="true" data-transition="slideup">
                <div data-role="header" data-theme="a">
                    <h1>¡Upsss!</h1>
                </div>
                <div role="main" class="ui-content popup-text">
                    <h3 class="ui-title">Ya existe un usuario con ese email o teléfono</h3>
                        <p class="ui-subtitle">¡Vuelve a intentarlo!</p>
                    <a href="#" class="ui-btn ui-btn-b ui-corner-all ui-ok-button" data-rel="back" data-transition="slideup">OK</a>
                </div>
            </div>
        </div>
            <div data-role="footer" data-position="fixed">
                <h4></h4>
            </div>
        </div>

    <div data-role="page" id="main-menu">
        <div data-role="header">
            <h1 class="ui-title-page">Menú principal</h1>
        </div>

        <div role="main" class="ui-content">
            <ul data-role="listview">
                <li><a href="#info-doc" data-transition="slide" class="main-menu-item" onclick="getProfesionales()">Buscar profesionales</a></li>
                <li><a href="#" data-transition="slide" class="main-menu-item">Mis consultas</a></li>
                <li><a href="#centro-med" data-transition="slide" class="main-menu-item" onclick="getCentrosMedicos()">Centros médicos</a></li>
                <li><a href="#" data-transition="slide" class="main-menu-item">Favoritos</a></li>
                <li><a href="#start-menu" data-transition="slide" data-direction="reverse" class="main-menu-item">Cerrar sesión</a></li>
            </ul>
        </div>
        <div data-role="footer" data-position="fixed">
            <h4></h4>
        </div>
    </div>

    <div data-role="page" id="info-doc">
        <div data-role="header">
            <a href="#main-menu" data-rel="back" data-transition="slide" data-direction="reverse" data-icon="arrow-left"
            class="ui-link ui-btn ui-icon-arrow-left ui-btn-icon-left ui-shadow ui-corner-all"></a>
            <h1 class="ui-title-page">Profesionales</h1>
        </div>

        <div role="main" class="ui-content doclist">
            <form class="ui-filterable">
                <input id="filter-doclist" data-type="search" placeholder="Buscar..">
            </form>

            <ul id="listviewDoc" data-role="listview" data-inset="true" data-filter="true" data-input="#filter-doclist">
            </ul>
        </div>
        <div data-role="footer" data-position="fixed">
            <h4></h4>
        </div>
    </div>

    <div data-role="page" id="info-doc-detalle">
            <div data-role="header">
                <a href="#info-doc" data-rel="back" data-transition="slide" data-direction="reverse" data-icon="arrow-left"
                class="ui-link ui-btn ui-icon-arrow-left ui-btn-icon-left ui-shadow ui-corner-all"></a>
                <h1 class="ui-title-page">Detalle de profesional</h1>
            </div>

            <div role="main" class="ui-content doclist">
                <div class="card">
                </div>
            </div>     
            <div data-role="footer" data-position="fixed">
                <div data-role="navbar">
                    <ul id="footerOptions">
                        <li><a href="#doc-consulta" data-role="button" data-icon="calendar" data-transition="slideup"
                        class="doclist-option inlineIcon"><span class="doclist-option-text">Agendar</span></a></li>
                        <li><a href="index.html" data-role="button" data-icon="heart" data-transition="slideup"
                        class="doclist-option inlineIcon"><span class="doclist-option-text">Favorito</span></a></li>
                        <li><a id="calificar-consulta" data-role="button" data-icon="star" data-transition="slideup"
                        class="doclist-option inlineIcon"><span class="doclist-option-text">Calificar</span></a></li>
                    </ul>
                </div>
                <div data-role="popup" id="PopupPuntaje" class="Popup" data-overlay-theme="a" data-theme="a" data-dismissible="true" data-transition="slideup">
                    <div data-role="header" data-theme="a">
                        <a href="#" class="ui-link ui-btn ui-icon-delete ui-btn-icon-right ui-shadow ui-corner-all" onclick="$('#PopupPuntaje').popup('close');"></a>
                        <h1>¡Yeyyy!</h1>
                    </div>
                    <div role="main" class="ui-content popup-text">
                        <h3 class="ui-title">Por favor, ingresa calificación para tu doctor</h3>
                        <input type="number" name="doctorcal" id="doctorCal">
                        <a href="#" id="ui-ok-button-puntaje" class="ui-btn ui-btn-b ui-corner-all ui-ok-button" data-rel="back" data-transition="slideup"
                        onclick="asignarPuntajeAProfesional()">OK</a>
                    </div>
                </div>
            </div>
        </div>

        <div data-role="page" id="doc-consulta">
            <div data-role="header">
                <a href="#info-doc-detalle" data-rel="back" data-transition="slideup" data-direction="reverse" data-icon="arrow-left"
                class="ui-link ui-btn ui-icon-arrow-left ui-btn-icon-left ui-shadow ui-corner-all"></a>
                <h1 class="ui-title-page">Agendar consulta</h1>
            </div>

            <div role="main" class="ui-content">
                <form id="formRes" autocomplete="off">
                    <fieldset data-role="fieldcontain">
                    <label class="ReservaInput" for="fechaRes">Fecha</label>
                    <input type="text" name="fecha" id="fechaRes" data-role="datebox" data-options='{"mode":"calbox", "useLang":"es",
                    "overrideDateFormat": "%d/%m/%Y" }'>
                    </fieldset>
                    <fieldset data-role="fieldcontain">
                    <label class="ReservaInput" for="horaRes">Hora</label>
                    <input type="text" name="hora" id="horaRes" data-role="datebox" data-options='{"mode":"timebox"}'>
                    </fieldset>              
                <div class="button">
                    <a href="#" id="reservar-consulta" class="ui-btn ui-btn-b ui-corner-all">Reservar</a>
                </div>
            </form>
            </div>
        <div data-role="footer" data-position="fixed">
            <h4></h4>
        </div>
    </div>

        <div data-role="page" id="centro-med">
            <div data-role="header">
                <a href="#main-menu" data-rel="back" data-transition="slide" data-direction="reverse" data-icon="arrow-left"
                class="ui-link ui-btn ui-icon-arrow-left ui-btn-icon-left ui-shadow ui-corner-all"></a>
                <img class="appLogo" src="img/images/heartbeat.png" alt="logo"> 
            </div>

            <div role="main" class="ui-content medlist">
                <form class="ui-filterable">
                    <input id="filter-medlist" data-type="search" placeholder="Buscar..">
                </form>
            <ul id="listviewMed" data-role="listview" data-inset="true" data-filter="true" data-input="#filter-medlist">
            </ul>
            </div>  
        <div data-role="footer" data-position="fixed">
            <h4></h4>
        </div>
    </div>
</body>
</html>